# Override para produção com Traefik
# Use: docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d

services:
  web:
    # Garantir que a imagem seja mantida
    image: "ghcr.io/azuracast/azuracast:${AZURACAST_VERSION:-latest}"
    
    # Variáveis de ambiente para sobrescrever portas do .env
    environment:
      - AZURACAST_HTTP_PORT=10080
      - AZURACAST_HTTPS_PORT=10443
    
    # Adiciona network externa do Traefik (mantém azuracast_internal e adiciona gwan)
    networks:
      - azuracast_internal
      - gwan
    
    # Labels do Traefik para roteamento HTTPS
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=gwan"

      # Router HTTP (redireciona para HTTPS)
      - "traefik.http.routers.azuracast-http.rule=Host(`radio.gwan.com.br`)"
      - "traefik.http.routers.azuracast-http.entrypoints=web"
      - "traefik.http.routers.azuracast-http.middlewares=azuracast-redirect"

      # Router HTTPS
      - "traefik.http.routers.azuracast.rule=Host(`radio.gwan.com.br`)"
      - "traefik.http.routers.azuracast.entrypoints=websecure"
      - "traefik.http.routers.azuracast.tls=true"
      - "traefik.http.routers.azuracast.tls.certresolver=letsencrypt"
      - "traefik.http.routers.azuracast.middlewares=azuracast-headers"

      # Middleware: Redirect HTTP to HTTPS
      - "traefik.http.middlewares.azuracast-redirect.redirectscheme.scheme=https"
      - "traefik.http.middlewares.azuracast-redirect.redirectscheme.permanent=true"

      # Middleware: Headers para proxy reverso
      - "traefik.http.middlewares.azuracast-headers.headers.customrequestheaders.X-Forwarded-Proto=https"
      - "traefik.http.middlewares.azuracast-headers.headers.customrequestheaders.X-Forwarded-Host=radio.gwan.com.br"
      - "traefik.http.middlewares.azuracast-headers.headers.customrequestheaders.X-Real-IP="

      # Service: AzuraCast (HTTP dentro do container na porta 80)
      - "traefik.http.services.azuracast.loadbalancer.server.port=80"
    
    # Portas: Usar portas alternativas para evitar conflito com Traefik
    # O Traefik acessa o container via network Docker na porta 80 interna
    # Portas HTTP/HTTPS são apenas internas (10080/10443), não expostas externamente
    ports:
      - "10080:80"       # HTTP interno (não exposto externamente)
      - "10443:443"      # HTTPS interno (não exposto externamente)
      - "2022:2022"      # SFTP
      - "8000-8099:8000-8099"  # Streams de rádio

networks:
  azuracast_internal:
    driver: bridge
  gwan:
    external: true
