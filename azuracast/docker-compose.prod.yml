# Override para produção com Traefik
# Use: docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d

services:
  web:
    # Garantir que a imagem seja mantida
    image: "ghcr.io/azuracast/azuracast:${AZURACAST_VERSION:-latest}"
    
    # Adiciona network externa do Traefik (mantém azuracast_internal e adiciona gwan)
    networks:
      - azuracast_internal
      - gwan
    
    # Labels do Traefik para roteamento HTTPS
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=gwan"

      # ============================================
      # Rota: cast.gwan.com.br (Admin + API)
      # ============================================
      # Router HTTP (redireciona para HTTPS)
      - "traefik.http.routers.azuracast-http.rule=Host(`cast.gwan.com.br`)"
      - "traefik.http.routers.azuracast-http.entrypoints=web"
      - "traefik.http.routers.azuracast-http.middlewares=azuracast-redirect"

      # Router HTTPS
      - "traefik.http.routers.azuracast.rule=Host(`cast.gwan.com.br`)"
      - "traefik.http.routers.azuracast.entrypoints=websecure"
      - "traefik.http.routers.azuracast.tls=true"
      - "traefik.http.routers.azuracast.tls.certresolver=letsencrypt"
      - "traefik.http.routers.azuracast.middlewares=azuracast-headers"

      # ============================================
      # Rota: stream.gwan.com.br (Stream de Áudio)
      # ============================================
      # Router HTTP para stream (redireciona para HTTPS)
      - "traefik.http.routers.stream-http.rule=Host(`stream.gwan.com.br`)"
      - "traefik.http.routers.stream-http.entrypoints=web"
      - "traefik.http.routers.stream-http.middlewares=stream-redirect"

      # Router HTTPS para stream
      - "traefik.http.routers.stream.rule=Host(`stream.gwan.com.br`)"
      - "traefik.http.routers.stream.entrypoints=websecure"
      - "traefik.http.routers.stream.tls=true"
      - "traefik.http.routers.stream.tls.certresolver=letsencrypt"
      - "traefik.http.routers.stream.middlewares=stream-headers"

      # Middleware: Redirect HTTP to HTTPS (AzuraCast)
      - "traefik.http.middlewares.azuracast-redirect.redirectscheme.scheme=https"
      - "traefik.http.middlewares.azuracast-redirect.redirectscheme.permanent=true"

      # Middleware: Redirect HTTP to HTTPS (Stream)
      - "traefik.http.middlewares.stream-redirect.redirectscheme.scheme=https"
      - "traefik.http.middlewares.stream-redirect.redirectscheme.permanent=true"

      # Middleware: Headers para proxy reverso (AzuraCast)
      - "traefik.http.middlewares.azuracast-headers.headers.customrequestheaders.X-Forwarded-Proto=https"
      - "traefik.http.middlewares.azuracast-headers.headers.customrequestheaders.X-Forwarded-Host=cast.gwan.com.br"
      - "traefik.http.middlewares.azuracast-headers.headers.customrequestheaders.X-Real-IP="

      # Middleware: Headers para proxy reverso (Stream)
      - "traefik.http.middlewares.stream-headers.headers.customrequestheaders.X-Forwarded-Proto=https"
      - "traefik.http.middlewares.stream-headers.headers.customrequestheaders.X-Forwarded-Host=stream.gwan.com.br"
      - "traefik.http.middlewares.stream-headers.headers.customrequestheaders.X-Real-IP="

      # Service: AzuraCast (HTTP dentro do container na porta 80)
      - "traefik.http.services.azuracast.loadbalancer.server.port=80"

      # Service: Stream (HTTP dentro do container na porta 8000)
      - "traefik.http.services.stream.loadbalancer.server.port=8000"
    
    # IMPORTANTE: Em produção com Traefik, não precisamos expor portas HTTP/HTTPS
    # O Traefik acessa o container diretamente via network Docker nas portas 80 (admin) e 8000 (stream)
    # Apenas expomos SFTP e portas de stream adicionais que podem ser necessárias
    ports:
      - "2022:2022"      # SFTP
      # Streams: mapeia portas externas 10000-10099 para portas internas 8000-8099
      # Isso permite acesso direto por IP se necessário, mas o acesso principal é via stream.gwan.com.br
      # A porta 8000 é acessada via Traefik (stream.gwan.com.br), não precisa ser exposta externamente
      - "10000-10099:8000-8099"
    
    # Volumes: definidos explicitamente para garantir funcionamento no Portainer
    # Mesmo que sejam herdados do docker-compose.yml base, é melhor definir aqui também
    volumes:
      - station_data:/var/azuracast/stations
      - backups:/var/azuracast/backups
      - db_data:/var/lib/mysql
      - www_uploads:/var/azuracast/storage/uploads
      - shoutcast2_install:/var/azuracast/storage/shoutcast2
      - stereo_tool_install:/var/azuracast/storage/stereo_tool
      - rsas_install:/var/azuracast/storage/rsas
      - geolite_install:/var/azuracast/storage/geoip
      - sftpgo_data:/var/azuracast/storage/sftpgo
      - acme:/var/azuracast/storage/acme
      # Customizações CSS/JS (montado como read-only)
      - ./custom:/var/azuracast/www/backend/public/custom:ro
    
    # Variáveis de ambiente (herdadas do docker-compose.yml base)
    env_file:
      - azuracast.env
      - .env

volumes:
  # Volumes são definidos no docker-compose.yml base
  # Mas precisam estar aqui também para garantir criação no Portainer
  db_data: { }
  acme: { }
  shoutcast2_install: { }
  stereo_tool_install: { }
  rsas_install: { }
  geolite_install: { }
  sftpgo_data: { }
  station_data: { }
  www_uploads: { }
  backups: { }

networks:
  azuracast_internal:
    driver: bridge
  gwan:
    external: true
